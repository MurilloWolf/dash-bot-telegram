name: ðŸ”„ PR Automation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  pr-checks:
    name: ðŸ“‹ PR Quality Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Validate PR Title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
          scopes: |
            bot
            core
            infra
            config
            deps
            api
            ui
            docs
          requireScope: false

      - name: ðŸ“Š PR Size Analysis
        uses: CodelikeAGirl/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          s_label: 'size/S'
          m_label: 'size/M'
          l_label: 'size/L'
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: 'This PR is very large. Consider breaking it down into smaller PRs.'

      - name: ðŸ·ï¸ Auto Label
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

      - name: ðŸ“ Generate PR Description
        if: github.event.action == 'opened'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ” PR Analysis

            **Files Changed:** ${{ github.event.pull_request.changed_files }}
            **Lines Added:** +${{ github.event.pull_request.additions }}
            **Lines Removed:** -${{ github.event.pull_request.deletions }}

            ### ðŸ“‹ Checklist
            - [ ] Tests added/updated
            - [ ] Documentation updated
            - [ ] Breaking changes documented
            - [ ] Ready for review

            ### ðŸ§ª Testing Instructions
            Please provide instructions on how to test this PR.

            ---
            *This comment was automatically generated by GitHub Actions*

  pr-review-assignment:
    name: ðŸ‘¥ Review Assignment
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ‘¥ Auto Assign Reviewers
        uses: kentaro-m/auto-assign-action@v1.2.5
        with:
          configuration-path: .github/auto-assign.yml

  pr-merge-conditions:
    name: âœ… Merge Conditions
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      checks: read

    steps:
      - name: âœ… Check if ready to merge
        uses: pascalgn/merge-conditions-action@v0.1.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          conditions: |
            - "status-success=ci/build"
            - "status-success=ci/test"
            - "status-success=ci/lint"
            - "label!=work-in-progress"
            - "label!=do-not-merge"
            - "reviews>=1"

  auto-merge:
    name: ðŸ¤– Auto Merge
    runs-on: ubuntu-latest
    needs: [pr-checks, pr-merge-conditions]
    if: |
      github.event.pull_request.draft == false &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge') &&
      github.actor == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ¤– Auto merge dependabot PRs
        uses: pascalgn/auto-merge-action@v0.15.6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: squash
          merge_commit_message: automatic
